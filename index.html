<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Uygulaması</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            padding: 20px;
        }
        #chat-box {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            padding: 10px;
            background: #fff;
        }
        #message {
            width: 80%;
            padding: 10px;
            margin-right: 5px;
        }
        #send-button {
            padding: 10px 15px;
        }
    </style>
</head>
<body>
    <h1>Chat Uygulaması</h1>
    <div id="chat-box"></div>
    <input type="text" id="message" placeholder="Mesajınızı yazın..." autocomplete="off">
    <button id="send-button">Gönder</button>

    <script>
        const socket = new WebSocket(`ws://${window.location.host}`);  // WebSocket'e bağlanıyoruz

        const chatBox = document.getElementById('chat-box');
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message');

        // WebSocket bağlantısı açıldığında
        socket.addEventListener('open', function (event) {
            console.log('WebSocket bağlantısı kuruldu.');
        });

        // Sunucudan gelen mesajı alıp chat kutusuna ekle
        socket.addEventListener('message', function (event) {
            const messageElement = document.createElement('div');
            messageElement.textContent = event.data; // Gelen mesaj
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight; // En son mesaja kaydır
        });

        sendButton.addEventListener('click', sendMessage);

        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() === '') return; // Boş mesaj gönderme

            // Konum bilgisi alalım
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                
                // Ters geocoding ile gerçek adresi al
                getAddressFromCoordinates(latitude, longitude)
                    .then(address => {
                        // Mesajı konum ve adres bilgisi ile birlikte gönder
                        const fullMessage = `${message} (Konum: ${latitude}, ${longitude}, Adres: ${address})`;
                        socket.send(fullMessage);  // Mesajı WebSocket sunucusuna gönder

                        // Mesajı chat kutusuna da ekle
                        const messageElement = document.createElement('div');
                        messageElement.textContent = fullMessage;
                        chatBox.appendChild(messageElement);

                        // Mesaj alanını temizle
                        messageInput.value = '';

                        // Chat kutusunu otomatik aşağıya kaydır
                        chatBox.scrollTop = chatBox.scrollHeight;
                    })
                    .catch(error => {
                        alert('Adres bilgisi alınamadı: ' + error.message);
                    });

            }, error => {
                alert('Konum bilgisi alınamadı: ' + error.message);
            });
        }

        // Ters geocoding: Enlem ve boylamı kullanarak adresi almak
        function getAddressFromCoordinates(latitude, longitude) {
            const apiKey = 'AIzaSyCYbz2roDa0saKdj6AXm2pSHx15x1E51Io';  // Google API anahtarınızı buraya ekleyin
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&key=${apiKey}`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Geocoding API Yanıtı:', data);  // Yanıtı konsola yazdırarak kontrol edelim
                    if (data.status === 'OK' && data.results.length > 0) {
                        // İlk sonucu al ve adresi döndür
                        return data.results[0].formatted_address;
                    } else {
                        throw new Error('Adres bulunamadı. Durum: ' + data.status);
                    }
                })
                .catch(error => {
                    console.error('Geocoding Hatası:', error);
                    throw error;
                });
    </script>
</body>
</html>
